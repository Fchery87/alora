name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Run linter
        run: bun run lint
      - name: Run type check
        run: bun run typecheck
      - name: Run tests with coverage
        run: bun run test --coverage
      - name: Check coverage threshold
        run: |
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            bun exec vitest --coverage | tee coverage.txt
            COVERAGE=$(grep "All files" coverage.txt | awk '{print $NF}')
            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "Coverage is below 80%: $COVERAGE%"
              exit 1
            fi
          fi

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Build iOS
        run: bun run ios --no-dev-client
        env:
          EXPO_NO_DISTRIBUTION: "1"
        timeout-minutes: 30

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Build Android
        run: |
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          mkdir -p $ANDROID_HOME
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools" || true
          bun run android --no-dev-client
        env:
          EXPO_NO_DISTRIBUTION: "1"
        timeout-minutes: 30
